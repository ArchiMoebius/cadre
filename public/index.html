<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Cadre.Today</title>

  <script type="text/javascript" src="/socketcluster.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    html,
    body {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      font-family: 'Helvetica', 'Verdana', sans-serif;
      font-weight: 400;
      font-display: optional;
      color: #333;
    }

    html {
      overflow: hidden;
    }

    body {
      background-color: #dae2eb;
      width: 100%;
      height: 100% !important;
    }

    div#messageAndLoginWrapper {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100% !important;
    }

    label {
      font-size: 18px;
    }

    div#login {
      flex-direction: column;
      width: 350px;
      margin: 5px;
      text-align: center;
      background-color: #eee;
      padding: 30px;
      -webkit-border-radius: 5px;
      -moz-border-radius: 5px;
      border-radius: 1px;
      box-shadow: 0px 1px 2px 1px rgba(133, 133, 133, 0.49);
      -webkit-box-shadow: 0px 1px 2px 1px rgba(133, 133, 133, 0.49);
      -moz-box-shadow: 0px 1px 2px 1px rgba(133, 133, 133, 0.49);
    }

    div#login div {
      margin: 5px;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
    }

    div#login div input#authenticate {
      width: 100%;
    }

    div#login,
    div#app,
    div#failure {
      display: none;
    }

    div#app {
      flex-flow: row wrap;
      font-weight: bold;
      text-align: center;
    }

    div#app>* {
      flex: 1 100%;
    }

    header {
      display: flex;
      justify-content: space-between;
      background-color: #333;
      text-align: center;
      align-items: center;
      color: white;
    }

    footer {
      background: lightgreen;
      position: absolute;
      right: 0;
      bottom: 0;
      left: 0;
      text-align: center;
    }

    header span {
      float: left;
      display: block;
      color: #f2f2f2;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
      font-size: 17px;
    }

    header nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    header nav a {
      float: left;
      display: block;
      color: #f2f2f2;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
      font-size: 17px;
    }

    header nav a:last-child {
      margin-left: auto;
      flex: 1;
      max-width: 100px;
    }

    header nav a:hover {
      background-color: #dae2eb;
      color: black;
    }

    header nav a.active {
      background-color: #4CAF50;
      color: white;
    }

    .sticky {
      position: fixed;
      top: 0;
      width: 100%;
    }

    @media all and (min-width: 600px) {
      .main {
        flex: 1 auto;
      }
    }

    @media all and (min-width: 800px) {
      .main {
        flex: 3 0px;
        order: 2;
      }
      .header {
        order: 1;
      }
      .footer {
        order: 3;
      }
    }

    .tooltip {
      position: relative;
      display: inline-block;
      border-bottom: 1px dotted black;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 0;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: -30%;
      margin-left: -60px;
      top: 38px;
      right: 105%;
      opacity: 0;
      transition: opacity 0.3s;
      height: 38px;
      justify-content: center;
      display: flex;
      align-items: center;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 0.95;
    }
  </style>
</head>

<body>
  <div id="messageAndLoginWrapper">
    <div id="failure">
      Something went wrong...Your browser might be outdated (ergo unable to use this page)!...
    </div>
    <div id="load">
      Please wait while we load things...
    </div>
    <div id="login">
      <div>
        <label for="username">Username</label>
        <input id="username" type="text" name="username" value="" />
      </div>
      <div>
        <label for="password">Password</label>
        <input id="password" type="password" name="password" value="" onkeypress="return login(event)" />
      </div>
      <div>
        <input id="authenticate" type="button" name="login" value="Login" />
      </div>
    </div>
  </div>
  <div id="app">
    <header>
      <nav>
        <img src="/img/logo.png"/ width="32" height="32" alt="Cadre.today">
        <a class="active" href="/index.html">Home</a>
        <a href="/streams.html">Streams</a>
        <a href="javascript:void(0)" id="logout" class="tooltip">Logout<span class="tooltiptext" id="username"></span></a>
      </nav>
    </header>
    <div id="main">
    </div>
    <footer>Footer</footer>
  </div>

  <script type="text/javascript">
    function notifyUser(message) {

      if (!("Notification" in window)) {
        alert(message);
      } else if (Notification.permission === "granted") {
        new Notification(message);
      } else if (Notification.permission === "denied") {
        alert(message);
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission(function(permission) {
          if (permission === "granted") {
            var notification = new Notification(message);
          }
        });
      }
    }

    var socket = socketCluster.connect();
    var selectors = {
      wrapper: document.querySelector('div#messageAndLoginWrapper'),
      load: document.querySelector('div#load'),
      failure: document.querySelector('div#failure'),
      login: {
        wrapper: document.querySelector('div#login'),
        username: document.querySelector('input#username'),
        password: document.querySelector('input#password'),
        authenticate: document.querySelector('input#authenticate')
      },
      app: {
        wrapper: document.querySelector('div#app'),
        header: {
          wrapper: document.querySelector('div#app header'),
          navbar: document.querySelector('div#app header nav'),
          username: document.querySelector('div#app header nav a span#username'),
          logout: document.querySelector('a#logout'),
          main: document.querySelector('div#app div#main')
        },
      },
    };

    var page = {
      showLogin: function() {
        selectors.load.style.display = "none";
        selectors.app.wrapper.style.display = "none";
        selectors.login.wrapper.style.display = "flex";
        selectors.wrapper.style.display = "flex";

        if (selectors.login.username.value) {
          selectors.login.password.focus();
        } else {
          selectors.login.username.focus();
        }
      },
      showApp: function() {
        selectors.load.style.display = "none";
        selectors.wrapper.style.display = "none";
        selectors.failure.style.display = "none";
        selectors.app.wrapper.style.display = "flex";

        var authToken = socket.getAuthToken();

        if (!authToken) {
          page.showFailure();
        } else {
          selectors.app.header.username.innerHTML = "Bye " + authToken.username;

          authToken.channels.forEach(function(channel) {
            var subscription = socket.subscribe(channel, {'waitForAuth': true});

            subscription.watch(function(data) {
              console.log("got data!", data);
            });
            subscription.on('subscribe', function(channel, options) {
              subscription.publish({"message": "hey world, you suck." + channel});
            });
          });
        }
      },
      showFailure: function() {
        selectors.load.style.display = "none";
        selectors.failure.style.display = "flex";
        selectors.wrapper.style.display = "flex";
      },
      authenticate: function(socket) {
        socket.emit(
          'login', {
            username: selectors.login.username.value,
            password: selectors.login.password.value
          },
          function(response) {

            selectors.login.password.value = '';

            if (response && response.error) {
              notifyUser(response.error);
            }
          }
        )
      }
    };

    function login(evt) {

      if (evt.which == 13 || evt.keyCode == 13) {
        page.authenticate(socket);
        return false;
      }
      return true;
    }

    selectors.login.authenticate.onclick = function() {
      page.authenticate(socket);
    };

    selectors.app.header.logout.onclick = function() {
      socket.emit('logout');
      page.showLogin();
    };

    // TODO: selectors.login.username.onblur check if username exists using bloomfilter, change text from login to register if doesn't exist?

    socket.on('error', function(err) {
      console.error(err); //TODO: notifyUser(err);?
      page.showFailure(); //TODO: catch all the error states and take the correct action (fail gracefully if possible...)
    });

    socket.on('connect', function(status) {

      if (!status.isAuthenticated) {
        page.showLogin();
      }
    });

    socket.on('authenticate', function(authToken) {
      page.showApp();
    });

    //
    // socket.on('random', function(data) {
    //   console.log('Received "random" event with data: ' + data.number);
    // });
    //
    // var sampleChannel = socket.subscribe('sample');
    //
    // sampleChannel.on('subscribeFail', function(err) {
    //   console.error('Failed to subscribe to the sample channel due to error: ' + err);
    // });
    //
    // sampleChannel.watch(function(num) {
    //   console.log('Sample channel message:', num);
    // });

    window.onscroll = function() {
      stickyNavbar()
    };

    var sticky = selectors.app.header.navbar.offsetTop;

    function stickyNavbar() {

      if (window.pageYOffset >= sticky) {
        selectors.app.header.navbar.classList.add("sticky")
      } else {
        selectors.app.header.navbar.classList.remove("sticky");
      }
    }
  </script>
</body>

</html>

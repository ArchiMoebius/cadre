<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Cadre.Today</title>

  <script type="text/javascript" src="/socketcluster.js"></script>

  <link media="all" rel="stylesheet" href="/css/index.css"></link>

</head>

<body>
  <div id="messageWrapper">
    <div id="failure">
      Something went wrong...Your browser might be outdated (ergo unable to use this page)!...
    </div>
    <div id="load">
      Please wait while we load things...
    </div>
  </div>
  <div id="app">
    <header>
      <nav>
        <img src="/img/logo.png"/ width="32" height="32" alt="Cadre.today">
        <a class="active" href="/index.html">Home</a>
        <a href="/streams.html">Streams</a>
        <a href="javascript:void(0)" id="logout" class="tooltip">Logout<span class="tooltiptext" id="username"></span></a>
      </nav>
    </header>
    <div id="main">
    </div>
    <footer>Footer</footer>
  </div>

  <script type="text/javascript">
    function notifyUser(message) {

      if (!("Notification" in window)) {
        alert(message);
      } else if (Notification.permission === "granted") {
        new Notification(message);
      } else if (Notification.permission === "denied") {
        alert(message);
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission(function(permission) {
          if (permission === "granted") {
            var notification = new Notification(message);
          }
        });
      }
    }

    var socket = socketCluster.connect();
    var selectors = {
      wrapper: document.querySelector('div#messageWrapper'),
      load: document.querySelector('div#load'),
      failure: document.querySelector('div#failure'),
      app: {
        wrapper: document.querySelector('div#app'),
        header: {
          wrapper: document.querySelector('div#app header'),
          navbar: document.querySelector('div#app header nav'),
          username: document.querySelector('div#app header nav a span#username'),
          logout: document.querySelector('a#logout'),
          main: document.querySelector('div#app div#main')
        },
      },
    };

    var page = {
      showApp: function() {
        selectors.load.style.display = "none";
        selectors.wrapper.style.display = "none";
        selectors.failure.style.display = "none";
        selectors.app.wrapper.style.display = "flex";

        var authToken = socket.getAuthToken();

        if (!authToken) {
          page.showFailure();
        } else {
          selectors.app.header.username.innerHTML = "Bye " + authToken.username;

          authToken.channels.forEach(function(channel) {
            var subscription = socket.subscribe(channel, {'waitForAuth': true});

            subscription.watch(function(data) {
              console.log("got data!", data);
            });
            subscription.on('subscribe', function(channel, options) {
              subscription.publish({"message": "hey world, you suck." + channel});
            });
          });
        }
      },
      showFailure: function() {
        selectors.load.style.display = "none";
        selectors.failure.style.display = "flex";
        selectors.wrapper.style.display = "flex";
      }
    };

    selectors.app.header.logout.onclick = function() {
      socket.emit('logout');
    };

    socket.on('deauthenticate', function() {
      window.location = 'login.html';
    });

    socket.on('error', function(err) {
      console.error(err); //TODO: notifyUser(err);?
      page.showFailure(); //TODO: catch all the error states and take the correct action (fail gracefully if possible...)
    });

    socket.on('connect', function(status) {

      if (!status.isAuthenticated) {
        window.location = 'login.html';
      }
    });

    socket.on('authenticate', function(authToken) {
      page.showApp();
    });

    window.onscroll = function() {
      stickyNavbar()
    };

    var sticky = selectors.app.header.navbar.offsetTop;

    function stickyNavbar() {

      if (window.pageYOffset >= sticky) {
        selectors.app.header.navbar.classList.add("sticky")
      } else {
        selectors.app.header.navbar.classList.remove("sticky");
      }
    }
  </script>
</body>

</html>
